
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="AgResearch & NeSI">
      
      
        <link rel="canonical" href="https://nesi.github.io/APSIM-HPC/">
      
      
      
        <link rel="next" href="1-runtime-info/">
      
      
      <link rel="icon" href="images/icon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.41">
    
    
      
        <title>APSIM-HPC</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Lato";--md-code-font:"Fira Code"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#apsim-hpc" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="APSIM-HPC" class="md-header__button md-logo" aria-label="APSIM-HPC" data-md-component="logo">
      
  <img src="images/icon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            APSIM-HPC
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/nesi/APSIM-HPC" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    nesi/APSIM-HPC
  </div>
</a>
      </div>
    
  </nav>
  
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="APSIM-HPC" class="md-nav__button md-logo" aria-label="APSIM-HPC" data-md-component="logo">
      
  <img src="images/icon.png" alt="logo">

    </a>
    APSIM-HPC
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/nesi/APSIM-HPC" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    nesi/APSIM-HPC
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Home
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-apptainer-build" class="md-nav__link">
    <span class="md-ellipsis">
      1. Apptainer build
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-setup-the-working-directory" class="md-nav__link">
    <span class="md-ellipsis">
      2. Setup the working directory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-update-workflow-files-for-current-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      3. Update Workflow files for current simulation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Update Workflow files for current simulation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#03-generate-config-filesgenerate_apsim_configsr" class="md-nav__link">
    <span class="md-ellipsis">
      03-generate-config-files/generate_apsim_configs.R
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#08-snakemakesnakefile_1" class="md-nav__link">
    <span class="md-ellipsis">
      08-snakemake/Snakefile_1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#08-snakemakesnakefile_2" class="md-nav__link">
    <span class="md-ellipsis">
      08-snakemake/Snakefile_2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-submit-the-workflow-to-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      4. Submit the workflow to Scheduler
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="1-runtime-info/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Runtime data
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-apptainer-build" class="md-nav__link">
    <span class="md-ellipsis">
      1. Apptainer build
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-setup-the-working-directory" class="md-nav__link">
    <span class="md-ellipsis">
      2. Setup the working directory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-update-workflow-files-for-current-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      3. Update Workflow files for current simulation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Update Workflow files for current simulation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#03-generate-config-filesgenerate_apsim_configsr" class="md-nav__link">
    <span class="md-ellipsis">
      03-generate-config-files/generate_apsim_configs.R
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#08-snakemakesnakefile_1" class="md-nav__link">
    <span class="md-ellipsis">
      08-snakemake/Snakefile_1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#08-snakemakesnakefile_2" class="md-nav__link">
    <span class="md-ellipsis">
      08-snakemake/Snakefile_2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-submit-the-workflow-to-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      4. Submit the workflow to Scheduler
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<p><center></p>
<h1 id="apsim-hpc">APSIM-HPC<a class="headerlink" href="#apsim-hpc" title="Permanent link">&para;</a></h1>
<p></center></p>
<p>Deploy APSIM (Agricultural Production Systems sIMulator - <a href="https://www.apsim.info/">https://www.apsim.info/</a>) on high performance computing clusters.</p>
<p><center>
<a class="glightbox" href="images/overall.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image" src="images/overall.png" /></a>
</center></p>
<h2 id="1-apptainer-build">1. Apptainer build<a class="headerlink" href="#1-apptainer-build" title="Permanent link">&para;</a></h2>
<div class="admonition terminal-2">
<p class="admonition-title">Building the APSIM container</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/nesi/APSIM-HPC.git
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nb">cd</span><span class="w"> </span>APSIM-HPC/01-apptainer-build
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>./updateversion-and-build.sh
</code></pre></div>
<details class="video">
<summary><code>./updateversion-and-build.sh</code></summary>
<p><video width="100%" controls>
  <source src="https://github.com/user-attachments/assets/a342fcd4-55e9-4615-896b-7eac46368e84" type="video/mp4">
  Your browser does not support the video tag.
</video></p>
</details>
</div>
<p><br></p>
<div class="admonition note"></div>
<h2 id="2-setup-the-working-directory">2. Setup the working directory<a class="headerlink" href="#2-setup-the-working-directory" title="Permanent link">&para;</a></h2>
<div class="admonition circle-info">
<p class="admonition-title">Structure/Content of the working directory</p>
<p>APSIM requires Weather files ( .met), Template to create the config files, CSV files with soil,file,database names and soil library .apsimx files to be on the same working directory.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>├──<span class="w"> </span><span class="m">1</span>.met
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>├──<span class="w"> </span><span class="m">2</span>.met
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>├──<span class="w"> </span><span class="m">3</span>.met
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>├──<span class="w"> </span>another_soilapsim_library.apsimx
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>├──<span class="w"> </span>ExampleConfigTemplate.txt
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>├──<span class="w"> </span>fileanddbnames.csv
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>├──<span class="w"> </span>my_master_soilapsim_library.apsimx
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>└──<span class="w"> </span>soilnames.csv
</code></pre></div>
</div>
<p><br></p>
<div class="admonition note"></div>
<h2 id="3-update-workflow-files-for-current-simulation">3. Update Workflow files for current simulation<a class="headerlink" href="#3-update-workflow-files-for-current-simulation" title="Permanent link">&para;</a></h2>
<div class="admonition quote">
<p>Please make sure to edit the files within the cloned repository without changing the repository directory structure or filenames. Final submission script relies on the existing structure and names to populate the working directory with runtime scripts.</p>
</div>
<h3 id="03-generate-config-filesgenerate_apsim_configsr"><code>03-generate-config-files/generate_apsim_configs.R</code><a class="headerlink" href="#03-generate-config-filesgenerate_apsim_configsr" title="Permanent link">&para;</a></h3>
<ul>
<li>This script generates the config.txt files ( one file per soil sample per weather file)</li>
<li>It will be executed interactively than submitting as a job to scheduler ( relatively quick -  generating 10,000 files will be done within 75 seconds or so)</li>
<li>Last step of this script is to "split" those config files to multiple <strong>Sets</strong> (Default is 3 <strong>Sets</strong>)<ul>
<li>What is the purpose of this <strong>split</strong> ?<ul>
<li>This a pre-configuration for <code>08-snakemake/Snakefile_1</code> step. Latter process the config files and create the corresponding .apsimx files ( plus the .db placeholder files). It can not be done in parallel due to <a href="https://github.com/nesi/APSIM-HPC/issues/31">https://github.com/nesi/APSIM-HPC/issues/31</a>. </li>
<li>Since the processing time per file is ~25 seconds, having all of the configfiles ( assuming there are thousands to process) in one single directory will add unreasonable runtimes. Safest ( and the easiest) soution is to split those files to multiple <strong>Sets</strong> ( processing within a set is still serial but it will be quicker as it will be a fraction of the total samples)</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="admonition r-project">
<p class="admonition-title">update <code>03-generate-config-files/generate_apsim_configs.R</code></p>
<p>First file to be edited is <code>03-generate-config-files/generate_apsim_configs.R</code> which will be used to generate the config.txt files</p>
<ul>
<li>Review line number 6, 8 and 11 </li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="m">6</span><span class="w"> </span><span class="n">SoilNames</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.vector</span><span class="p">(</span><span class="nf">unlist</span><span class="p">(</span><span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;soilnames.csv&quot;</span><span class="p">)))</span><span class="w"> </span><span class="c1">##List of soil names that must exist in the Soil Library .apsimx file (most likely supplied by experienced APSIM user)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="m">8</span><span class="w"> </span><span class="n">ConfigTemplate</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;ExampleConfigTemplate.txt&quot;</span><span class="w"> </span><span class="c1">##Base config file</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="m">11</span><span class="w"> </span><span class="n">SoilLibrary</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;my_master_soilapsim_library.apsimx&quot;</span><span class="w"> </span><span class="c1">###Change name to the soil library you are using</span>
</code></pre></div>
<ul>
<li>if you would like to change the number of <strong>Sets</strong> from default <code>3</code>, change the value of <code>nSets</code> on line 87</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="m">87</span><span class="w"> </span><span class="nf">SplitConfigFilesIntoSets</span><span class="p">(</span><span class="nf">list.files</span><span class="p">(</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ConfigFile.txt$&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">nSets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
</code></pre></div>
</div>
<h3 id="08-snakemakesnakefile_1"><code>08-snakemake/Snakefile_1</code><a class="headerlink" href="#08-snakemakesnakefile_1" title="Permanent link">&para;</a></h3>
<ul>
<li>This step is scheduler based. It generates the .apsimx ( and placeholder .db files) from config files</li>
<li>This is a serial process  ( as described above) which makes it the longest step in terms of runtime in the workflow ( take ~25 seconds per config file)</li>
<li>Default runtime assigned to this step is <strong>16 hours</strong> ( this is sufficient to handle a set of 2300 files)</li>
</ul>
<div class="admonition snake">
<p class="admonition-title">update <code>08-snakemake/Snakefile_1</code></p>
<ul>
<li>All major changes are within the <code>config</code> block<ul>
<li><code>apptainer_bind</code> - We recommend binding the full filesystem. <ul>
<li>For <strong>eRI</strong>, It will be <code>"apptainer_bind": "/agr/scratch,/agr/persist"</code></li>
<li>For <strong>Mahuika</strong>, it's <code>"apptainer_bind": "/nesi/project,/nesi/nobackup,/opt/nesi"</code></li>
</ul>
</li>
<li><code>"excluded_txt_files"</code> is the name of the template config which will excluded during the processing. Otherwise, it will create a .apsimx and a place holder .db file for itself</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="w">   </span><span class="m">4</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">   </span><span class="m">5</span><span class="w">     </span><span class="s2">&quot;apptainer_bind&quot;</span>:<span class="w"> </span><span class="s2">&quot;/full/filesystem&quot;</span>,
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">   </span><span class="m">6</span><span class="w">     </span><span class="s2">&quot;apptainer_image&quot;</span>:<span class="w"> </span><span class="s2">&quot;/path/to/container/image/version.aimg&quot;</span>,
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">   </span><span class="m">7</span><span class="w">     </span><span class="s2">&quot;excluded_txt_files&quot;</span>:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;ExampleConfigTemplate.txt&quot;</span><span class="o">]</span>,
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">   </span><span class="m">8</span><span class="w">     </span><span class="s2">&quot;max_consecutive_failures&quot;</span>:<span class="w"> </span><span class="m">10</span>,
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">   </span><span class="m">9</span><span class="w">     </span><span class="s2">&quot;slurm_logdir&quot;</span>:<span class="w"> </span><span class="s2">&quot;slurmlogs&quot;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">  </span><span class="m">10</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
<ul>
<li>If you would like to increase the runtime, refer to <strong>line 28</strong> </li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w">  </span><span class="m">28</span><span class="w">         </span><span class="nb">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;16:00:00&quot;</span>
</code></pre></div>
</div>
<h3 id="08-snakemakesnakefile_2"><code>08-snakemake/Snakefile_2</code><a class="headerlink" href="#08-snakemakesnakefile_2" title="Permanent link">&para;</a></h3>
<ul>
<li>This step is scheduler based. It generates the .db from .apsimx files</li>
<li>Processing will be done in parallel .i.e. Each .apsimx file will have it's own job. Average processing time per file at 12 cpus varies between 50 seconds to 5 minutes. We have set the default to be 10 minutes per file. Similar to above, change the <code>time =</code> varibale as needed.</li>
</ul>
<div class="admonition snake">
<p class="admonition-title">update <code>08-snakemake/Snakefile_2</code></p>
<ul>
<li>Simlar to above, all changes are within the <code>config</code> block<ul>
<li><code>"excluded_apsimx_files"</code> is/are the name/s of the soil library .apsimx files which will excluded during the processing. Otherwise, it will create a .db file/s for those</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="w">   </span><span class="m">5</span><span class="w"> </span><span class="nv">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">   </span><span class="m">6</span><span class="w">     </span><span class="s2">&quot;apptainer_bind&quot;</span>:<span class="w"> </span><span class="s2">&quot;/full/filesystem&quot;</span>,
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">   </span><span class="m">7</span><span class="w">     </span><span class="s2">&quot;apptainer_image&quot;</span>:<span class="w"> </span><span class="s2">&quot;/path/to/container/image/version.aimg&quot;</span>,
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">   </span><span class="m">8</span><span class="w">     </span><span class="s2">&quot;excluded_apsimx_files&quot;</span>:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;my_master_soilapsim_library.apsimx&quot;</span>,<span class="w"> </span><span class="s2">&quot;another_soilapsim_library.apsimx&quot;</span><span class="o">]</span>,
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">   </span><span class="m">9</span><span class="w">     </span><span class="s2">&quot;slurm_logdir&quot;</span>:<span class="w"> </span><span class="s2">&quot;slurmlogs&quot;</span>,
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="m">10</span><span class="w">     </span><span class="s2">&quot;size_threshold&quot;</span>:<span class="w"> </span><span class="m">1</span><span class="w"> </span>*<span class="w"> </span><span class="m">1024</span><span class="w"> </span>*<span class="w"> </span><span class="m">1024</span><span class="w">  </span><span class="c1"># 1MB in bytes</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">  </span><span class="m">11</span><span class="w"> </span><span class="o">}</span>
</code></pre></div>
</div>
<p><br></p>
<div class="admonition note"></div>
<h2 id="4-submit-the-workflow-to-scheduler">4. Submit the workflow to Scheduler<a class="headerlink" href="#4-submit-the-workflow-to-scheduler" title="Permanent link">&para;</a></h2>
<div class="admonition bulb">
<p class="admonition-title">Assumptions and pre-requisites</p>
<ol>
<li>Cloned the latest version of the repo (<a href="https://github.com/nesi/APSIM-HPC.git">https://github.com/nesi/APSIM-HPC.git</a>)</li>
<li><code>03-generate-config-files/generate_apsim_configs.R</code> , <code>08-snakemake/Snakefile_1</code> and <code>08-snakemake/Snakefile_2</code> were updated with names of the template files,etc. </li>
<li>Filenames and directory structure of the <strong>cloned repo</strong> <strong>were/was not</strong> altered.<ul>
<li>submission script relies on the relative paths and names as it is within the Github repo.</li>
<li>If you are to change paths or names, make sure to review <code>submit.sh</code> and amend to reflect the changes.  </li>
</ul>
</li>
</ol>
</div>
<div class="admonition rocket">
<p class="admonition-title">Launch it with the command <code>source submit.sh</code></p>
<p>What does it do : </p>
<p><center><a class="glightbox" href="images/workflow.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image" src="images/workflow.png" width="500" /></a></center></p>
<details class="clipboard-question">
<summary>Reason for using <code>source</code> and not <code>bash</code></summary>
<ul>
<li>
<p>This is do with <code>cd /working/directory</code> command within the <code>submit.sh</code> script</p>
</li>
<li>
<p>When you run a script using <code>bash script.sh</code>, the script is executed in a new subshell. This means:</p>
<ul>
<li>A new shell process is created to run the script.</li>
<li>Any changes to the working directory (<code>cd</code> commands) only affect this subshell.</li>
<li>Once the script finishes, the subshell terminates, and you return to your original shell with its original working directory unchanged.</li>
</ul>
</li>
</ul>
</details>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
        
          
          <a href="1-runtime-info/" class="md-footer__link md-footer__link--next" aria-label="Next: Runtime data">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Runtime data
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      APSIM-HPC is licensed under a <a rel="noopener" target="_blank" href="https://github.com/nesi/APSIM-HPC/blob/docs/LICENSE">MIT License</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer", "navigation.tabs.sticky", "content.code.copy", "content.code.annotate"], "search": "assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>